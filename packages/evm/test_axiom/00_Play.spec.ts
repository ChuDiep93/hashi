/*
Note that these E2E tests simulate cross-chain interactions but,
for the sake of convenience, use only one network as both the origin and destination chain.

*/
import { expect } from "chai"
import { ethers, network } from "hardhat"

const DOMAIN_ID = network.config.chainId
const BYTES32_DOMAIN_ID = "0x0000000000000000000000000000000000000000000000000000000000007A69"

// const ID_ZERO = 0
const ID_ONE = 10000000
const ID_TWO = 2
const CryptoPunkAddress = "0xb47e3cd837ddf8e4c57f05d70ab865de6e193bbb"
// https://etherscan.io/tx/0x324ba0703e783108b0b5f66ab520de9b13529b6bb7db789ce8f39f1369973a43
// storage key for cryptopunk 0xb47e3cd837dDF8e4c57F05d70Ab865de6e193BBB
// https://demo.axiom.xyz/custom
// Function: attestSlots((uint32,bytes32,bytes32,uint32,bytes32[10]), bytes)
// #	Name	Type	Data
// 0	blockData.blockNumber	uint32	10000000
// 0	blockData.claimedBlockHash	bytes32	0xaa20f7bde5be60603f11a45fc4923aab7552be775403fc00c2e6b805e6297dbe
// 0	blockData.prevHash	bytes32	0x00dccd7227da056f4a439347923411d11e7756a88e3c9d4efbe9852cee671b65
// 0	blockData.numFinal	uint32	1024
// 0	blockData.merkleProof	bytes32[10]	0x7823fa4da327cf97a9b86da990b0755ebfaa3b490ecd0be80b0ed24106d1a8d7,0x126a2dc8ecfedc0ceb5d312da2ad5f88a93c6a3f4a38a8b778bc5ccb1d39f937,0x0cf1cf53800ec678d0deacea8ef8e57747185fa438c5a823f25274ecc3613463,0x356b4d133078199280cf008daddc4bc4ebc2fd543e144b6e01859b026a5c5115,0xbf337229d4003538b1d2b44c21c5b566b6036a00c2d389204222d328dbb72821,0xeb259a83488c376707bd80d3bc63e1b55bf6ed9248ea72392ffc7f125133293d,0x93d75de9876136b28cb9334615785f472696a7fe448c5b983c0f1f916de033b3,0xd7bdbe170113c89491892ea3fd0e4f9a0ec17109141536e78550e82ee6860f28,0xe16c89a378abf45439eb41475f93fb52c38bc987425f5bcebbcd13ec3f0d36df,0x4f57444b9a4f732d077c3c3062043ff61ff001afed844cd074e00c5f73c64f5d
// 2	proof	bytes	0x000000000000000000000000000000000000000000af8fdb20c227d925248e42000000000000000000000000000000000000000000644db7116af142304717e2000000000000000000000000000000000000000000002063eb172efc8cd28c7700000000000000000000000000000000000000000084da9135a9629d12a554af00000000000000000000000000000000000000000058bb95a1264192c555eb180000000000000000000000000000000000000000000008b46561cf0d581f19d9000000000000000000000000000000000000000000e6c200773117d79ace781f00000000000000000000000000000000000000000091411a01fc5663579b998a00000000000000000000000000000000000000000000201f607169410341ed5300000000000000000000000000000000000000000003beb92fd8db4c92fc4323000000000000000000000000000000000000000000c2de15bab300d3b076e1dc000000000000000000000000000000000000000000002ef20ab8392eed55288700000000000000000000000000000000aa20f7bde5be60603f11a45fc4923aab000000000000000000000000000000007552be775403fc00c2e6b805e6297dbe0000000000000000000000000000000000000000000000000000000000989680000000000000000000000000b47e3cd837ddf8e4c57f05d70ab865de6e193bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000043727970746f50756e6b73000000000000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a2c417b53ac258dea0e9c3a09d465fa7b2ad9817949830926652cccf9e457ccff0a3520e219203ce55d67133c7044e722cd1c62b332863afac1b8aa172925e51a038d06fea82e77649ee6ff7d78478d50e4f76c29297f011806f3ea5087092b5021d6565ad78f3fe4b586de17653d0d83c54f020d8edc847f715b188fe8c9b5df00f76251d51443cbeb6de48750b01e75dcf232105c77d8b1ad56ca45daa1fe751dad7cf6b6c5aba58e16fb2c380fb861cbf69228fbd662736341e4ebe19beae02ee2ff31085b71de6b8ea37fcd87e5e040ab0ce40f84f4919a5f8da433e8e0421d923eec9ca9d87ceee7307df0da870d03e6c86dc7a2ceb975290856d49a14f716f87687189db783f45fc071cc00b57479efacd2a81d20d80ade7d9cc3b9427604a354b94ea14fc45a8821e424b2432770416b635c14488aaa56d021ada72b30259a5cc3dbc0c70b4033990cf0256b00a2bb4e3f95091011abb04dcb167d20a10b5962c321f9250c76008f986767a4fb019595b307af3e17ed8667606c4c02b011205e3aaca1c0e3fdaf0fe0440c13b393cc60818cd3807e717a671655a850b22f3d3fe0ae70e5be87b078dfa93ffe024857feadcc85444a38f4cb5815cf837f1027ba5859ac2347603af8d92b864641f276ea731575d905d8aeb7c5bf0614a70c8f50c5eb504142756459bf9ad890a1e98a0c0bb6985753b032e39234d78d8b1334e88a5c5345456317bf3c323f5059ed451bff0a3b98b7b7bcd2a6a2e2eda4029a0257f2ae62da324efdc2d501415659153b3fddc4de0325e1ee2334f1c7ce0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000229c401756e1f1bf00a43e9091579781658e52d2411c09444b529c1c604cd09bd2447dc0526bb32fd06a26544d5c564f89260eb2c34315d7538bef78fd24243062fb0db58ebc6fb463894fab1fe0cda941d0bbcc97011875b95324ce68e255a5123cda5eb0f1404d4dfbbf6322010bc1f63a6701a10f3333b61a0bb199fafce330982d83b8646a63f6dfdbebd4c6e6f6c622cc64ca598e65c3a9b43bebbb401fe211f9c1cde3f95f867527cc14bde911e94fd3115b725803b83a768a5aa6bfaba056ed9da84987ba89dc11838efc71789395cbdbb8bc51e731979409744e0b28f19806de8bc36e2335fb77f561b7535be30c51451ad60ff9d6c3dea8591f6bad00d80f4627e6fc496a8d35efc7ee2247ebc1fe940c966115965e04019ee73ae47213ddc26f47c6bd48ccc6059d9da9ea91538cf9f80f4e3be8fed91e85f90150802bf21cb3805aab138e17ac6ea5433eab028a0dfe206364e2acc4e074fcefabf03b7df4afc594d202ca2a892afd4935e5a5fd9a7e80c9be3d26926a217af5aae00420c111a7311fa500ae6e95fcf52cbee8378be50b85ba9e7fd9f4f1afdf0a216b20f3e7fd807e8695ce1689de2c62aa79fad10c9a5f621bcf25fd4e59b80b11fd0f3ddf53445b77fdb5cc9384532b17db631d4c371ec8582dcb79c4d14cd9e2501804dae3e71f9b8434bbc808363dd4d79b1248b35b15053c31c2b26edd2e0181c0bb5c799a84a9c219e0cfe55ed78b5ead9a441ab1812d3d0f0d07b9334a801d91543a42d1763640f8eccaca82af95415a88fe494607edac09fadf6c6f75227a04bc30233135a1ced057f0866cc8398a18c8547f767027d99a9a728fc1d4c00000000000000000000000000000000000000000000000000000000000000011d5d1460c917d52426c75b3be66a3273eea78f1bb27c9193cd44c23c8f6a84e520f0005a8cc725d671c522b3babef27c1adb38ebd18f41dabf581794df165676251d1f286f5cb238c1d95e149b37ec6a0ada2b65416303d371ed8607cd9558f711d3eca5b425ddb7ae6ab6760cf36123e63da627bfaa93f6d35cba5b22511bc5192609ee19ae267f2cd42ee93174692da524a1109daef4a06bbe47cb4880fda21854b7719fe26e00ee5de50d57cd229724f0370a1f860cfc95a8d7c117d5f23c2d0866e798112bf67b647c2ad0e83fcecc1abd2989350d45345611f63db5d2201f34c4a32c3d98e498455036c20f3601caa007f71691d53efa0ba7bfcde3594f155e0dbde630af0736817e818df64c8acf53b63ec316464f5963d7c6d33f55d602d6a3d6de0b695bddfab9e74fa87cfb72cf377f35f79ae8602e8fdc8ea8550e085347ca45e928f8025696856778d660d957b26faa90e5c731b57a3a7891457e0b5f5d9530b74eecf70b2c7b0b6dc936d86fb86e5d057f55cc260ffd0eba583d1a2e20d53b9fd6abcd0629bc5ba9bafde1b28b1d39d68853ddc05a49bb1c083d062c135ac184127e8ade0ad40b765f51f9a01d4242e36189ec8352259953ab2c27ccbba9c63f44a0614c7801d179515d945a135d9aad8df9d32d4b36bf6a8e680726e91a97cb641fa4f7f624dd260bf17a97393a642232319846f9052ba3e3c51a2d48aee7f6d0309964e5210eeb8d7597febbe7a86a3e8bdfb087020902899901020c077d97947319135f61d8b72801357bfc280f4254ab1b3f33fad2b05cc021c7bf12369c7d9e322669d04581a4aab17855b6789db89209c4911799b3980d152507f853337bbffb5634153fd157a5881706377ad3ad104d3030cf76b57d88178b2ff9f0c150022c23dec41317d668e7b756a8a2d57c891b23e12c0910397027b491d766663c03a534cb9c8b4681e28f4121d2f8fa9ce7b7e9a866b4762ed4

function web3StringToBytes32(text) {
  var result = ethers.utils.hexlify(ethers.utils.toUtf8Bytes(text))
  while (result.length < 66) {
    result += "0"
  }
  if (result.length !== 66) {
    throw new Error("invalid web3 implicit bytes32")
  }
  return result
}

const blockHashWitness = {
  blockNumber: 10000000,
  claimedBlockHash: "0xaa20f7bde5be60603f11a45fc4923aab7552be775403fc00c2e6b805e6297dbe",
  prevHash: "0x00dccd7227da056f4a439347923411d11e7756a88e3c9d4efbe9852cee671b65",
  numFinal: 1024,
  merkleProof: [
    "0x7823fa4da327cf97a9b86da990b0755ebfaa3b490ecd0be80b0ed24106d1a8d7",
    "0x126a2dc8ecfedc0ceb5d312da2ad5f88a93c6a3f4a38a8b778bc5ccb1d39f937",
    "0x0cf1cf53800ec678d0deacea8ef8e57747185fa438c5a823f25274ecc3613463",
    "0x356b4d133078199280cf008daddc4bc4ebc2fd543e144b6e01859b026a5c5115",
    "0xbf337229d4003538b1d2b44c21c5b566b6036a00c2d389204222d328dbb72821",
    "0xeb259a83488c376707bd80d3bc63e1b55bf6ed9248ea72392ffc7f125133293d",
    "0x93d75de9876136b28cb9334615785f472696a7fe448c5b983c0f1f916de033b3",
    "0xd7bdbe170113c89491892ea3fd0e4f9a0ec17109141536e78550e82ee6860f28",
    "0xe16c89a378abf45439eb41475f93fb52c38bc987425f5bcebbcd13ec3f0d36df",
    "0x4f57444b9a4f732d077c3c3062043ff61ff001afed844cd074e00c5f73c64f5d",
  ],
}

const proof =
  "0x000000000000000000000000000000000000000000af8fdb20c227d925248e42000000000000000000000000000000000000000000644db7116af142304717e2000000000000000000000000000000000000000000002063eb172efc8cd28c7700000000000000000000000000000000000000000084da9135a9629d12a554af00000000000000000000000000000000000000000058bb95a1264192c555eb180000000000000000000000000000000000000000000008b46561cf0d581f19d9000000000000000000000000000000000000000000e6c200773117d79ace781f00000000000000000000000000000000000000000091411a01fc5663579b998a00000000000000000000000000000000000000000000201f607169410341ed5300000000000000000000000000000000000000000003beb92fd8db4c92fc4323000000000000000000000000000000000000000000c2de15bab300d3b076e1dc000000000000000000000000000000000000000000002ef20ab8392eed55288700000000000000000000000000000000aa20f7bde5be60603f11a45fc4923aab000000000000000000000000000000007552be775403fc00c2e6b805e6297dbe0000000000000000000000000000000000000000000000000000000000989680000000000000000000000000b47e3cd837ddf8e4c57f05d70ab865de6e193bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000043727970746f50756e6b73000000000000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000c352b53400000000000000000000000000000000e8b987e036a93539fd6897f53488e56a2c417b53ac258dea0e9c3a09d465fa7b2ad9817949830926652cccf9e457ccff0a3520e219203ce55d67133c7044e722cd1c62b332863afac1b8aa172925e51a038d06fea82e77649ee6ff7d78478d50e4f76c29297f011806f3ea5087092b5021d6565ad78f3fe4b586de17653d0d83c54f020d8edc847f715b188fe8c9b5df00f76251d51443cbeb6de48750b01e75dcf232105c77d8b1ad56ca45daa1fe751dad7cf6b6c5aba58e16fb2c380fb861cbf69228fbd662736341e4ebe19beae02ee2ff31085b71de6b8ea37fcd87e5e040ab0ce40f84f4919a5f8da433e8e0421d923eec9ca9d87ceee7307df0da870d03e6c86dc7a2ceb975290856d49a14f716f87687189db783f45fc071cc00b57479efacd2a81d20d80ade7d9cc3b9427604a354b94ea14fc45a8821e424b2432770416b635c14488aaa56d021ada72b30259a5cc3dbc0c70b4033990cf0256b00a2bb4e3f95091011abb04dcb167d20a10b5962c321f9250c76008f986767a4fb019595b307af3e17ed8667606c4c02b011205e3aaca1c0e3fdaf0fe0440c13b393cc60818cd3807e717a671655a850b22f3d3fe0ae70e5be87b078dfa93ffe024857feadcc85444a38f4cb5815cf837f1027ba5859ac2347603af8d92b864641f276ea731575d905d8aeb7c5bf0614a70c8f50c5eb504142756459bf9ad890a1e98a0c0bb6985753b032e39234d78d8b1334e88a5c5345456317bf3c323f5059ed451bff0a3b98b7b7bcd2a6a2e2eda4029a0257f2ae62da324efdc2d501415659153b3fddc4de0325e1ee2334f1c7ce0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000229c401756e1f1bf00a43e9091579781658e52d2411c09444b529c1c604cd09bd2447dc0526bb32fd06a26544d5c564f89260eb2c34315d7538bef78fd24243062fb0db58ebc6fb463894fab1fe0cda941d0bbcc97011875b95324ce68e255a5123cda5eb0f1404d4dfbbf6322010bc1f63a6701a10f3333b61a0bb199fafce330982d83b8646a63f6dfdbebd4c6e6f6c622cc64ca598e65c3a9b43bebbb401fe211f9c1cde3f95f867527cc14bde911e94fd3115b725803b83a768a5aa6bfaba056ed9da84987ba89dc11838efc71789395cbdbb8bc51e731979409744e0b28f19806de8bc36e2335fb77f561b7535be30c51451ad60ff9d6c3dea8591f6bad00d80f4627e6fc496a8d35efc7ee2247ebc1fe940c966115965e04019ee73ae47213ddc26f47c6bd48ccc6059d9da9ea91538cf9f80f4e3be8fed91e85f90150802bf21cb3805aab138e17ac6ea5433eab028a0dfe206364e2acc4e074fcefabf03b7df4afc594d202ca2a892afd4935e5a5fd9a7e80c9be3d26926a217af5aae00420c111a7311fa500ae6e95fcf52cbee8378be50b85ba9e7fd9f4f1afdf0a216b20f3e7fd807e8695ce1689de2c62aa79fad10c9a5f621bcf25fd4e59b80b11fd0f3ddf53445b77fdb5cc9384532b17db631d4c371ec8582dcb79c4d14cd9e2501804dae3e71f9b8434bbc808363dd4d79b1248b35b15053c31c2b26edd2e0181c0bb5c799a84a9c219e0cfe55ed78b5ead9a441ab1812d3d0f0d07b9334a801d91543a42d1763640f8eccaca82af95415a88fe494607edac09fadf6c6f75227a04bc30233135a1ced057f0866cc8398a18c8547f767027d99a9a728fc1d4c00000000000000000000000000000000000000000000000000000000000000011d5d1460c917d52426c75b3be66a3273eea78f1bb27c9193cd44c23c8f6a84e520f0005a8cc725d671c522b3babef27c1adb38ebd18f41dabf581794df165676251d1f286f5cb238c1d95e149b37ec6a0ada2b65416303d371ed8607cd9558f711d3eca5b425ddb7ae6ab6760cf36123e63da627bfaa93f6d35cba5b22511bc5192609ee19ae267f2cd42ee93174692da524a1109daef4a06bbe47cb4880fda21854b7719fe26e00ee5de50d57cd229724f0370a1f860cfc95a8d7c117d5f23c2d0866e798112bf67b647c2ad0e83fcecc1abd2989350d45345611f63db5d2201f34c4a32c3d98e498455036c20f3601caa007f71691d53efa0ba7bfcde3594f155e0dbde630af0736817e818df64c8acf53b63ec316464f5963d7c6d33f55d602d6a3d6de0b695bddfab9e74fa87cfb72cf377f35f79ae8602e8fdc8ea8550e085347ca45e928f8025696856778d660d957b26faa90e5c731b57a3a7891457e0b5f5d9530b74eecf70b2c7b0b6dc936d86fb86e5d057f55cc260ffd0eba583d1a2e20d53b9fd6abcd0629bc5ba9bafde1b28b1d39d68853ddc05a49bb1c083d062c135ac184127e8ade0ad40b765f51f9a01d4242e36189ec8352259953ab2c27ccbba9c63f44a0614c7801d179515d945a135d9aad8df9d32d4b36bf6a8e680726e91a97cb641fa4f7f624dd260bf17a97393a642232319846f9052ba3e3c51a2d48aee7f6d0309964e5210eeb8d7597febbe7a86a3e8bdfb087020902899901020c077d97947319135f61d8b72801357bfc280f4254ab1b3f33fad2b05cc021c7bf12369c7d9e322669d04581a4aab17855b6789db89209c4911799b3980d152507f853337bbffb5634153fd157a5881706377ad3ad104d3030cf76b57d88178b2ff9f0c150022c23dec41317d668e7b756a8a2d57c891b23e12c0910397027b491d766663c03a534cb9c8b4681e28f4121d2f8fa9ce7b7e9a866b4762ed4"

const setup = async () => {
  const [wallet] = await ethers.getSigners()

  // deploy hashi
  const Hashi = await ethers.getContractFactory("Hashi")
  const hashi = await Hashi.deploy()

  // deploy GiriGiriBashi
  const GiriGiriBashi = await ethers.getContractFactory("GiriGiriBashi")
  const giriGiriBashi = GiriGiriBashi.deploy(wallet.address, hashi.address)

  // deploy Yaho
  const Yaho = await ethers.getContractFactory("Yaho")
  const yaho = await Yaho.deploy()

  // deploy AMB
  const AMB = await ethers.getContractFactory("MockAMB")
  const amb = await AMB.deploy()

  const axiomAddressMainnet = "0xF990f9CB1A0aa6B51c0720a6f4cAe577d7AbD86A"
  const verifierAddress = "0x29052F4F5e96d71772AD2b145f8C3eb7db4DB33E"
  const AxiomV02 = await ethers.getContractFactory("AxiomV02")
  const axiomV02 = await AxiomV02.deploy(axiomAddressMainnet, verifierAddress)

  const AxiomV02StorageProf = await ethers.getContractFactory("AxiomV02StoragePf")
  const storageProof = await AxiomV02StorageProf.deploy(axiomAddressMainnet, verifierAddress, hashi.address)

  return {
    amb,
    wallet,
    hashi,
    giriGiriBashi,
    yaho,
    storageProof,
  }
}

describe("End-to-end tests", function () {
  describe("Execution layer", function () {
    it("Attest slots for the claimed block head with the block hash agreed on by N adapters", async function () {
      const { amb, hashi, storageProof } = await setup()

      // deploy header storage
      const HeaderStorage = await ethers.getContractFactory("HeaderStorage")
      const headerStorage = await HeaderStorage.deploy()

      // deploy AMBHeaderReporter
      const AMBHeaderReporter = await ethers.getContractFactory("AMBHeaderReporter")
      const ambHeaderReporter = await AMBHeaderReporter.deploy(amb.address, headerStorage.address)

      // deploy AMBAdapter
      const AMBAdapter = await ethers.getContractFactory("AMBAdapter")
      const ambAdapter = await AMBAdapter.deploy(amb.address, ambHeaderReporter.address, BYTES32_DOMAIN_ID)

      await ambHeaderReporter.reportHeaders([ID_ONE], ambAdapter.address, 10000000)

      let expectedHash = await headerStorage.headers(ID_ONE)
      expect(
        await hashi.getHash(
          DOMAIN_ID,
          ID_ONE,
          // TODO: currently we query the AMB adapter twice. We should query two or more different adapters.
          [ambAdapter.address, ambAdapter.address],
        ),
      ).to.equal(expectedHash)

      const attestation = await storageProof.attestSlotsWithHashi(
        proof,
        DOMAIN_ID,
        ID_ONE,
        blockHashWitness.claimedBlockHash,
        [ambAdapter.address, ambAdapter.address],
      )

      // uint32 blockNumber, address addr, uint256 slot, uint256 slotValue
      // https://etherscan.io/tx/0x324ba0703e783108b0b5f66ab520de9b13529b6bb7db789ce8f39f1369973a43#eventlog
      await expect(attestation).to.emit(storageProof, "SlotAttestationEvent")
    })

    it("Reverts if the claimed block header is different from the block hash agreed on by N adapters", async function () {
      const { amb, hashi, storageProof } = await setup()

      // deploy header storage
      const HeaderStorage = await ethers.getContractFactory("HeaderStorage")
      const headerStorage = await HeaderStorage.deploy()

      // deploy AMBHeaderReporter
      const AMBHeaderReporter = await ethers.getContractFactory("AMBHeaderReporter")
      const ambHeaderReporter = await AMBHeaderReporter.deploy(amb.address, headerStorage.address)

      // deploy AMBAdapter
      const AMBAdapter = await ethers.getContractFactory("AMBAdapter")
      const ambAdapter = await AMBAdapter.deploy(amb.address, ambHeaderReporter.address, BYTES32_DOMAIN_ID)

      await ambHeaderReporter.reportHeaders([ID_ONE], ambAdapter.address, 10000000)

      let expectedHash = await headerStorage.headers(ID_ONE)
      expect(
        await hashi.getHash(
          DOMAIN_ID,
          ID_ONE,
          // TODO: currently we query the AMB adapter twice. We should query two or more different adapters.
          [ambAdapter.address, ambAdapter.address],
        ),
      ).to.equal(expectedHash)

      const invalidBlockHashWitness = {
        ...blockHashWitness,
        claimedBlockHash: "0x30db8cd39796630f83af6d4cb062a50f90d1768f8723f37af018be8b1d664e50",
      }

      await expect(
        storageProof.attestSlotsWithHashi(proof, DOMAIN_ID, ID_ONE, invalidBlockHashWitness.claimedBlockHash, [
          ambAdapter.address,
          ambAdapter.address,
        ]),
      ).to.revertedWith("block hash mismatch with hash block hash")
    })
  })
})
